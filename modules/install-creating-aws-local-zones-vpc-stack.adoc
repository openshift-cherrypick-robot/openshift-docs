:_content-type: PROCEDURE
[id="install-aws-local-zones-vpc-stack_{context}"]
=== Creating a VPC for AWS Local Zones

Create a virtual private cloud (VPC) to use with AWS Local Zones.

.Procedure
// TODO: GitHub links are not okay.
. From a command line, enter the following command to create the stack:
+
[source,terminal]
----
INSTALLER_URL="https://raw.githubusercontent.com/openshift/installer/master"
TPL_URL="${INSTALLER_URL}/upi/aws/cloudformation/01_vpc.yaml"

aws cloudformation create-stack \
    --region ${AWS_REGION} \
    --stack-name ${CLUSTER_NAME}-vpc \
    --template-body ${TPL_URL} \
    --parameters \
        ParameterKey=VpcCidr,ParameterValue=${VPC_CIDR} \
        ParameterKey=SubnetBits,ParameterValue=${VPC_SUBNETS_BITS} \
        ParameterKey=AvailabilityZoneCount,ParameterValue=${VPC_SUBNETS_COUNT}
----

. Enter the following command to wait for the stack creation to finish:
+
[source,terminal]
----
aws cloudformation wait stack-create-complete \
    --region ${AWS_REGION} \
    --stack-name ${CLUSTER_NAME}-vpc 
----
// TODO: jq is not okay.
. Enter the following command to export the VPC ID:
+
[source,terminal]
----
export VPC_ID=$(aws cloudformation describe-stacks \
  --region us-west-2 \
  --stack-name ${CLUSTER_NAME}-vpc \
  | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="VpcId").OutputValue' )
----
// TODO: jq
. Extract the subnets IDs to the environment variable list `SUBNETS`. For example:
+
[source,terminal]
----
mapfile -t SUBNETS < <(aws cloudformation describe-stacks \
  --region us-west-2 \
  --stack-name ${CLUSTER_NAME}-vpc \
  | jq -r '.Stacks[0].Outputs[0].OutputValue' | tr ',' '\n')
mapfile -t -O "${#SUBNETS[@]}" SUBNETS < <(aws cloudformation describe-stacks \
  --region us-west-2 \
  --stack-name ${CLUSTER_NAME}-vpc  \
  | jq -r '.Stacks[0].Outputs[1].OutputValue' | tr ',' '\n')
----

// TODO: jq
. Export the public route table ID. For example:
+
[source,terminal]
----
export PUBLIC_RTB_ID=$(aws cloudformation describe-stacks \
  --region us-west-2 \
  --stack-name ${CLUSTER_NAME}-vpc \
  | jq -r '.Stacks[0].Outputs[] | select(.OutputKey=="PublicRouteTableId").OutputValue' )
----

.Verification
 
* To review the variables that you exported, enter the following command:
+
[source,terminal]
----
echo "SUBNETS=${SUBNETS[*]}
VPC_ID=${VPC_ID}
PUBLIC_RTB_ID=${PUBLIC_RTB_ID}"
----