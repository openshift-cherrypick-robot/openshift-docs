:_content-type: ASSEMBLY
[id="installing-aws-vpc-local-zones"]
= Installing a cluster on AWS using AWS Local Zones
include::_attributes/common-attributes.adoc[]
:context: installing-aws-vpc-local-zones

toc::[]

In {product-title} version {product-version}, you can install a cluster into an existing Amazon Virtual Private Cloud (VPC) on Amazon Web Services (AWS) that uses AWS Local Zones. 

The installation program provisions the rest of the required infrastructure, which you can further customize. To customize the installation, modify parameters in the `install-config.yaml` file before you install the cluster.

== Prerequisites

* You reviewed details about the xref:../../architecture/architecture-installation.adoc#architecture-installation[{product-title} installation and update] processes.
* You read the documentation on xref:../../installing/installing-preparing.adoc#installing-preparing[selecting a cluster installation method and preparing it for users].
* You xref:../../installing/installing_aws/installing-aws-account.adoc#installing-aws-account[configured an AWS account] to host the cluster.
+
[IMPORTANT]
====
If you have an AWS profile stored on your computer, it must not use a temporary session token that you generated while using a multi-factor authentication device. The cluster continues to use your current AWS credentials to create AWS resources for the entire life of the cluster, so you must use long-lived credentials. To generate appropriate keys, see link:https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html[Managing Access Keys for IAM Users] in the AWS documentation. You can supply the keys when you run the installation program.
====
* You downloaded the AWS CLI and installed it on your computer.
* If you use a firewall, you xref:../../installing/install_config/configuring-firewall.adoc#configuring-firewall[configured it to allow the sites] that your cluster requires access to.
* If the cloud identity and access management (IAM) APIs are not accessible in your environment, or if you do not want to store an administrator-level credential secret in the `kube-system` namespace, you can xref:../../installing/installing_aws/manually-creating-iam.adoc#manually-creating-iam-aws[manually create and maintain IAM credentials].
* To use the AWS Local Zone deployment that is described in this document:
** Add permission for the user who creates the cluster to modify the Local Zone group with `ec2:ModifyAvailabilityZoneGroup`. For example:
+
.An example of a permissive IAM policy to attach to a user or role
[source,yaml]
----
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Stmt1677614927608",
      "Action": [
        "ec2:ModifyAvailabilityZoneGroup"
      ],
      "Effect": "Allow",
      "Resource": "*"
    }
  ]
}
----

** Export the following environment variables:
+
[source,terminal]
----
export CLUSTER_NAME="ipi-localzones"

# AWS Region and extra Local Zone group Information
export AWS_REGION="us-west-2"
export ZONE_GROUP_NAME="us-west-2-lax-1"
export ZONE_NAME="us-west-2-lax-1a"

# VPC Information
export VPC_CIDR="10.0.0.0/16"
export VPC_SUBNETS_BITS="10"
export VPC_SUBNETS_COUNT="3"

# Local Zone Subnet information
export SUBNET_CIDR="10.0.192.0/22"
export SUBNET_NAME="${CLUSTER_NAME}-public-usw2-lax-1a"
----

include::modules/edge-machine-pools-aws-local-zones.adoc[leveloffset=+1]


// TODO: This could just be a nixed w/the children bumped up a level.
:_content-type: PROCEDURE
[id="install-aws-local-zones-vpc-stack"]
== Creating the network stack

Create a network stack that involves a virtual private cloud (VPC) and an AWS Local Zones subnet. While you can create the VPC by using the instructions in xref:../../installing/installing_aws/installing-aws-vpc.adoc#installing-aws-vpc[Installing a cluster on AWS into an existing VPC], the following instructions use xref:../../installing/installing_aws/installing-aws-user-infra.adoc#installing-aws-user-infra[CloudFormation templates] that rely on the environment variables you already set.

include::modules/install-creating-aws-local-zones-vpc-stack.adoc[leveloffset=+2]
include::modules/install-creating-aws-local-zones-subnet.adoc[leveloffset=+2]

[id="installing-cluster-aws-local-zones"]
== Install the cluster

To install an OpenShift cluster in an existing VPC with subnets in Local Zones, follow these steps:

* Generate the `install-config.yaml` file or provide your own.
* Set the option `platform.aws.subnets` to add the subnet IDs.
* Optional: Customize the edge compute pool.

include::modules/install-creating-install-config-aws-local-zones.adoc[leveloffset=+2]
include::modules/machines-edge-machine-pool.adoc[leveloffset=+2]

include::modules/installation-launching-installer.adoc[leveloffset=+1]

include::modules/nw-aws-local-zones-user-workload-ingress.adoc[leveloffset=+1]

// TODO: I would prefer not to have teardown instructions for this guide if we can help it. Would the user likely be able to figure this out on their own or with AWS' docs?

// :_content-type: PROCEDURE
// == Removing the cluster

// :_content-type: PROCEDURE
// === Destroying the cluster

// [source,terminal]
// ----
// ./openshift-install destroy cluster --dir ${CLUSTER_NAME}
// ----

// :_content-type: PROCEDURE
// === Destroying the Local Zone subnets

// [source,terminal]
// ----
// aws cloudformation delete-stack \
//     --region ${AWS_REGION} \
//     --stack-name ${SUBNET_NAME}
// ----

// :_content-type: PROCEDURE
// === Destroying the VPC 

// [source,terminal]
// ----
// aws cloudformation delete-stack \
//     --region ${AWS_REGION} \
//     --stack-name ${CLUSTER_NAME}-vpc
// ----

// TODO: Shouldn't this be a blog post if anything?

// :content-type: REFERENCE
// == Use Cases

// :content-type: REFERENCE
// == A sample application deployment with edge machine pools and AWS Local Zones

// The example below creates one sample application on the node running in the Local zone, setting the tolerations needed to pin the pod on the correct node:

// [source,terminal]
// ----
// cat << EOF | oc create -f -
// apiVersion: v1
// kind: Namespace
// metadata:
//   name: local-zone-demo
// ---
// apiVersion: apps/v1
// kind: Deployment
// metadata:
//   name: local-zone-demo-app-nyc-1
//   namespace: local-zone-demo
// spec:
//   selector:
//     matchLabels:
//       app: local-zone-demo-app-nyc-1
//   replicas: 1
//   template:
//     metadata:
//       labels:
//         app: local-zone-demo-app-nyc-1
//         machine.openshift.io/zone-group: ${ZONE_GROUP_NAME}
//     spec:
//       nodeSelector:
//         machine.openshift.io/zone-group: ${ZONE_GROUP_NAME}
//       tolerations:
//       - key: "node-role.kubernetes.io/edge"
//         operator: "Equal"
//         value: ""
//         effect: "NoSchedule"
//       containers:
//         - image: openshift/origin-node
//           command:
//            - "/bin/socat"
//           args:
//             - TCP4-LISTEN:8080,reuseaddr,fork
//             - EXEC:'/bin/bash -c \"printf \\\"HTTP/1.0 200 OK\r\n\r\n\\\"; sed -e \\\"/^\r/q\\\"\"'
//           imagePullPolicy: Always
//           name: echoserver
//           ports:
//             - containerPort: 8080
// ---
// apiVersion: v1
// kind: Service 
// metadata:
//   name:  local-zone-demo-app-nyc-1 
//   namespace: local-zone-demo
// spec:
//   ports:
//     - port: 80
//       targetPort: 8080
//       protocol: TCP
//   type: NodePort
//   selector:
//     app: local-zone-demo-app-nyc-1
// EOF
// ----

